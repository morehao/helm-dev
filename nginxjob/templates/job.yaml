apiVersion: batch/v1
kind: Job
metadata:
  name: "post-install-job"
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
    "helm.sh/hook-weight": "0"
spec:
  template:
    spec:
      containers:
        - name: post-install
          image: "{{ .Values.postInstall.image | default "busybox:latest" }}"
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "=== å¼€å§‹æ‰§è¡Œ post-install ä»»åŠ¡ ===";
              echo "æ—¶é—´ï¼š$(date)";
              echo "ç¯å¢ƒï¼š{{ .Values.env | default "development" }}";
              echo "Pod åç§°ï¼š$HOSTNAME";
              echo "å‘½åç©ºé—´ï¼š$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)";
              
              echo "=== æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ ===";
              # ä½ çš„å®é™…é€»è¾‘æ”¾è¿™é‡Œ
              sleep 2;
              echo "å¤„ç†ä¸­...";
              sleep 1;
              
              echo "=== ä»»åŠ¡å®Œæˆ ===";
              echo "âœ… åç½®ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ";
              
              # è°ƒè¯•æ¨¡å¼ï¼šè®©å®¹å™¨ä¿æŒè¿è¡Œä¸€æ®µæ—¶é—´ï¼Œæ–¹ä¾¿æŸ¥çœ‹æ—¥å¿—
              {{- if .Values.debug }}
              echo "ğŸ› è°ƒè¯•æ¨¡å¼ï¼šå®¹å™¨å°†ä¿æŒè¿è¡Œ 300 ç§’";
              sleep 300;
              {{- else }}
              echo "æ­£å¸¸æ¨¡å¼ï¼šä»»åŠ¡å®Œæˆï¼Œå®¹å™¨å³å°†é€€å‡º";
              {{- end }}
          env:
            - name: ENV
              value: "{{ .Values.env | default "development" }}"
            - name: DEBUG
              value: "{{ .Values.debug | default false }}"
      restartPolicy: Never
  backoffLimit: 3
  activeDeadlineSeconds: 600  # 10åˆ†é’Ÿè¶…æ—¶